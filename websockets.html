<!DOCTYPE html>
<html>
  <head>
    <title>Websockets</title>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="game.js"></script>

    <script type="text/javascript">
      var DIRECTIONS = {LEFT: 37, RIGHT: 39, UP: 38, DOWN: 40};

      var keyCodes = {
        38: DIRECTIONS.UP, 
        40: DIRECTIONS.DOWN,
        37: DIRECTIONS.LEFT,
        39: DIRECTIONS.RIGHT
      }


      $('document').ready(function() {
        var initialized = false;

        var tickLength = 50; 
        var blockWidth = 5;

        var canvas = $('#canvas')[0];

        var game = new Game(blockWidth, canvas.width, canvas.height);
        var myIndex;

        var newDir;

        var socket = new WebSocket("ws://localhost:8080/");
        
        socket.onmessage = function(msg) {
          var parsed = JSON.parse(msg.data); 
          console.log(msg.data);
          if (parsed.hasOwnProperty("newPlayer")) {
            game.addPlayer(parsed["newPlayer"].pieces, parsed["newPlayer"].direction, parsed["newPlayer"].index);
            if (parsed["newPlayer"].hasOwnProperty("you") && parsed["newPlayer"].you) {
              myIndex = parsed["newPlayer"].index;
              newDir = parsed["newPlayer"].direction;
              $(document).keydown(function(e) {
                var dir = keyCodes[e.keyCode];
                if (dir) {
                  e.preventDefault();
                  newDir = dir;
                }
              });
            }
          }

          if (parsed.hasOwnProperty("updates")) {
            for (var i = parsed["updates"].length - 1; i >= 0; i--) {
              if (myIndex != i) {
                game.players[i].direction = parsed["updates"][i];
              }
            }
          }

          if (parsed.hasOwnProperty("tick")) {
            if (parsed["tick"]) {
              game.tick(); 
              draw(game.players, canvas);
              game.players[myIndex].direction = newDir;
              socket.send(game.players[myIndex].direction);
            }
          }
        }

        function draw(players, canvas) {
          var context = canvas.getContext('2d')
          context.beginPath();
          context.clearRect(0, 0, canvas.width, canvas.height);

          for (var i = players.length - 1; i >= 0; i--)
            for (var j = players[i].pieces.length - 1; j >= 0; j--) 
              context.fillRect(players[i].pieces[j].x, players[i].pieces[j].y, blockWidth, blockWidth);
              
          context.stroke();
        }

        /*
        var Player = function(initX, initY, initD, index) {
          this.index = index;
          this.pieces = [{x: initX, y: initY}];
          
          this.direction = initD;
  
          this.maxLen = 3;

          this.advance = function() {
            var newPiece;
            var lastPiece;

            if (this.pieces.length < this.maxLen) {
              lastPiece = this.pieces[this.pieces.length - 1];
              newPiece = {x: lastPiece.x, y: lastPiece.y};
            }

            for (var i = this.pieces.length - 1; i > 0; i--) {
              this.pieces[i] = {x: this.pieces[i - 1].x, y: this.pieces[i - 1].y};
            }
            
            switch (this.direction) {
              case DIRECTIONS.UP:
                this.pieces[0].y -= speed; 
                break;
              case DIRECTIONS.DOWN:
                this.pieces[0].y += speed;
                break;
              case DIRECTIONS.LEFT:
                this.pieces[0].x -= speed;
                break;
              case DIRECTIONS.RIGHT:
                this.pieces[0].x += speed;
                break;
            }

            this.pieces[0].x = wrap(this.pieces[0].x, 0, canvas.width);
            this.pieces[0].y = wrap(this.pieces[0].y, 0, canvas.height);
 
            if (newPiece) {
              this.pieces.push(newPiece);
            }
         
          };


          this.draw = function(context) {
            for (var i = this.pieces.length - 1; i >= 0; i--) {
              context.fillRect(this.pieces[i].x, this.pieces[i].y, blockWidth, blockWidth);
            }
          };
        }*/

        /*
        function tick() {
          c.beginPath();
          c.clearRect(0, 0, canvas.width, canvas.height);

          for (var i = guys.length - 1; i >= 0; i--) {
            guys[i].advance();
            guys[i].draw(c);
          }

          c.stroke();

          var arr = new Uint8Array(1);
          arr[0] = player.direction;
          socket.send(arr);

        }*/

/*
        

        var guys = [];
      //var socket = new WebSocket("ws://localhost:8080/");
      
      var myIndex;

      function getInitReader() {
        var initReader = new FileReader();
 
        initReader.addEventListener("loadend", function() {
          var result = new Uint16Array(initReader.result);
          newGuy = new Player(result[0], result[1], DIRECTIONS.RIGHT);
          guys.push(newGuy);

          if (!player)
            player = newGuy;
          else {
          opponent = newGuy; 
            }  
            });

        return initReader;
      }

      function getDirectionReader() {
        var dReader = new FileReader();

        dReader.addEventListener("loadend", function() {
              var result = new Uint8Array(dReader.result);
              opponent.direction = keyCodes[result[0]];
              tick();
              });

        return dReader;
        }*/
      /* 
      socket.onmessage = function(msg) {
        if (msg.data.size != 1) {
          var parsed = JSON.parse(msg.data);
          if (parsed.hasOwnProperty("set_index")) {
            myIndex = parsed.set_index;
          }
          var newGuy = new Player(parsed.where[0], parsed.where[1], DIRECTIONS.RIGHT, parsed.index);
          guys.push(newGuy);
          if (parsed.index == myIndex) {
            player = newGuy;
          } else {
            opponent = newGuy;
          }
        } else {
          var directionReader = getDirectionReader();
          directionReader.readAsArrayBuffer(msg.data);
        }
      }*/

      });
    </script>

  </head>
  <body>
    <canvas id = "canvas" width = "800" height = "600" style="border: solid blue 2px;"></canvas>
  </body>
</html>
